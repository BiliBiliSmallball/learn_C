#include "system.h"
#include "iic.h"

/*************************************************
函数名称：IIC_Hardware_Init
函数说明：IIC初始化	
输入参数：	无			
返 回 值：	无			
**************************************************/
void IIC_Hardware_Init(void)
{

    P2_Mode_PullUp(IIC_SCL_PIN | IIC_SDA_PIN);

    IIC_SCL(1);
    IIC_SDA(1);
}

/*************************************************
函数名称：SDA_In
函数说明：IIC输入配置	
输入参数：	无			
返 回 值：	无			
**************************************************/
void SDA_In(void)
{
    P2_Mode_HighZ(IIC_SDA_PIN);
}

/*************************************************
函数名称：SDA_Out
函数说明：IIC输出配置	
输入参数：	无			
返 回 值：	无			
**************************************************/
void SDA_Out(void)
{
    P2_Mode_PullUp(IIC_SDA_PIN);
}

/*************************************************
函数名称：IIC_Start
函数说明：产生IIC起始信号
输入参数：	无			
返 回 值：	无			
**************************************************/
void IIC_Start(void)
{
    SDA_Out();     //sda线输出
    IIC_SDA(1);
    IIC_SCL(1);
    Delay_us(4);
    IIC_SDA(0);//START:when CLK is high,DATA change form high to low
    Delay_us(4);
    IIC_SCL(0);//钳住I2C总线，准备发送或接收数据
}

/*************************************************
函数名称：IIC_Stop
函数说明：产生IIC停止信号
输入参数：	无			
返 回 值：	无			
**************************************************/
void IIC_Stop(void)
{
    SDA_Out();		//sda线输出
    IIC_SCL(0);
    IIC_SDA(0);		//STOP:when CLK is high DATA change form low to high
    Delay_us(4);
    IIC_SCL(1);
    IIC_SDA(1);		//发送I2C总线结束信号
    Delay_us(4);
}

/**********************************************************
*功    能：等待应答信号到来
*参    数：无
*返 回 值：1/接收应答失败；0/接收应答成功
**********************************************************/
uint8_t IIC_Wait_Ack(void)
{
    uint8_t ucErrTime = 0;
    SDA_In();      //SDA设置为输入
    IIC_SDA(1);
    Delay_us(1);
    IIC_SCL(1);
    Delay_us(1);

    while(READ_SDA)
    {
        ucErrTime++;

        if(ucErrTime > 250)
        {
            IIC_Stop();
            return 1;
        }
    }

    IIC_SCL(0);//时钟输出0
    return 0;
}

//产生ACK应答
void IIC_Ack(void)
{
    IIC_SCL(0);
    SDA_Out();
    IIC_SDA(0);
    Delay_us(2);
    IIC_SCL(1);
    Delay_us(2);
    IIC_SCL(0);
}

//不产生ACK应答
void IIC_NAck(void)
{
    IIC_SCL(0);
    SDA_Out();
    IIC_SDA(1);
    Delay_us(2);
    IIC_SCL(1);
    Delay_us(2);
    IIC_SCL(0);
}

/**********************************************************
*功    能：IIC发送一个字节
*参    数：txd
*返 回 值：无
**********************************************************/
void IIC_Send_Byte(uint8_t txd)
{
    uint8_t t;
    SDA_Out();
    IIC_SCL(0);//拉低时钟开始数据传输

    for(t = 0; t < 8; t++)
    {
        IIC_SDA(((txd & 0x80) >> 7));
        txd <<= 1;
        Delay_us(2);   //对TEA5767这三个延时都是必须的
        IIC_SCL(1);
        Delay_us(2);
        IIC_SCL(0);
        Delay_us(2);
    }
}

//读1个字节，ack=1时，发送ACK，ack=0，发送nACK
uint8_t IIC_Read_Byte(unsigned char ack)
{
    unsigned char i, receive = 0;
    SDA_In();//SDA设置为输入

    for(i = 0; i < 8; i++ )
    {
        IIC_SCL(0);
        Delay_us(2);
        IIC_SCL(1);
        receive <<= 1;

        if(READ_SDA)receive++;

        Delay_us(1);
    }

    if (!ack)
        IIC_NAck();//发送nACK
    else
        IIC_Ack(); //发送ACK

    return receive;
}







